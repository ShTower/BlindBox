<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试管理员功能</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            color: #333;
            margin-top: 0;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>🎁 盲盒管理后台功能测试</h1>
    
    <div class="test-card">
        <h3>📊 API连接测试</h3>
        <p>测试后端API是否正常运行</p>
        <button class="btn" onclick="testApiConnection()">测试API连接</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="test-card">
        <h3>📦 获取商品列表</h3>
        <p>测试获取所有商品数据</p>
        <button class="btn" onclick="testGetProducts()">获取商品列表</button>
        <div id="productsResult" class="result"></div>
    </div>

    <div class="test-card">
        <h3>➕ 添加测试商品</h3>
        <p>测试添加新商品功能</p>
        <button class="btn" onclick="testAddProduct()">添加测试商品</button>
        <div id="addResult" class="result"></div>
    </div>

    <div class="test-card">
        <h3>🔄 更新商品信息</h3>
        <p>测试更新商品功能（需要先添加商品）</p>
        <button class="btn" onclick="testUpdateProduct()">更新商品</button>
        <div id="updateResult" class="result"></div>
    </div>

    <div class="test-card">
        <h3>🗑️ 删除商品</h3>
        <p>测试删除商品功能（需要先添加商品）</p>
        <button class="btn" onclick="testDeleteProduct()">删除商品</button>
        <div id="deleteResult" class="result"></div>
    </div>

    <div class="test-card">
        <h3>🔗 管理员页面链接</h3>
        <p>点击下方链接访问管理员界面</p>
        <a href="http://localhost:3000/admin" target="_blank" class="btn">打开管理员页面</a>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let lastProductId = null;

        function displayResult(elementId, result, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(result, null, 2);
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        async function testApiConnection() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                const data = await response.json();
                displayResult('apiResult', {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    statusCode: response.status,
                    message: response.ok ? '后端API连接正常' : '后端API连接失败',
                    data: response.ok ? `找到 ${data.products?.length || 0} 个商品` : data
                });
            } catch (error) {
                displayResult('apiResult', {
                    status: 'ERROR',
                    message: '无法连接到后端服务器',
                    error: error.message
                }, false);
            }
        }

        async function testGetProducts() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                const data = await response.json();
                displayResult('productsResult', {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    productCount: data.products?.length || 0,
                    products: data.products?.slice(0, 3) || [] // 只显示前3个商品
                });
            } catch (error) {
                displayResult('productsResult', {
                    status: 'ERROR',
                    error: error.message
                }, false);
            }
        }

        async function testAddProduct() {
            try {
                const testProduct = {
                    name: '测试盲盒 ' + Date.now(),
                    description: '这是一个测试商品，用于验证管理员功能',
                    price: 99.99,
                    stock: 10,
                    image_url: 'https://via.placeholder.com/300x300?text=Test+Product'
                };

                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testProduct)
                });
                
                const data = await response.json();
                if (response.ok) {
                    lastProductId = data.product.id;
                }
                
                displayResult('addResult', {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    productId: data.product?.id,
                    message: data.message || data.error,
                    product: data.product
                });
            } catch (error) {
                displayResult('addResult', {
                    status: 'ERROR',
                    error: error.message
                }, false);
            }
        }

        async function testUpdateProduct() {
            if (!lastProductId) {
                displayResult('updateResult', {
                    status: 'ERROR',
                    message: '请先添加测试商品'
                }, false);
                return;
            }

            try {
                const updateData = {
                    name: '更新后的测试盲盒',
                    description: '这个商品已经被更新',
                    price: 129.99,
                    stock: 5,
                    image_url: 'https://via.placeholder.com/300x300?text=Updated+Product'
                };

                const response = await fetch(`${API_BASE}/products/${lastProductId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                displayResult('updateResult', {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    productId: lastProductId,
                    message: data.message || data.error,
                    product: data.product
                });
            } catch (error) {
                displayResult('updateResult', {
                    status: 'ERROR',
                    error: error.message
                }, false);
            }
        }

        async function testDeleteProduct() {
            if (!lastProductId) {
                displayResult('deleteResult', {
                    status: 'ERROR',
                    message: '请先添加测试商品'
                }, false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products/${lastProductId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                displayResult('deleteResult', {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    productId: lastProductId,
                    message: data.message || data.error
                });
                
                if (response.ok) {
                    lastProductId = null;
                }
            } catch (error) {
                displayResult('deleteResult', {
                    status: 'ERROR',
                    error: error.message
                }, false);
            }
        }
    </script>
</body>
</html>
